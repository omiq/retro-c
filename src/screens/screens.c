#include "screens.h"
#include "../display/display.h"
#include "../input/input.h"

#if defined (__CC65__)
#include <conio.h>
#include <stdio.h>
#include <peekpoke.h>
#include <string.h>
#else
#include "../include/notconio.h"
#endif

#ifdef __C64__
// Custom character set data - 8x8 pixel patterns for each character
static const unsigned char chars[] = {
     92, 87,233, 89, 57, 30, 20, 54,
 16, 40, 40, 68,124, 68,238,  0,
252, 66, 66,124, 66, 66,252,  0,
 56, 68,130,128,130, 68, 56,  0,
252, 66, 66, 66, 66, 66,252,  0,
254, 66, 72,120, 72, 66,254,  0,
254, 66, 72,120, 72, 64,224,  0,
 60, 66,128,142,130, 66, 60,  0,
238, 68,124, 68, 68, 68,238,  0,
254, 16, 16, 16, 16, 16,254,  0,
124, 16, 16, 16,144,144, 96,  0,
238, 68, 72,112, 72, 68,238,  0,
224, 64, 64, 64, 66, 66,254,  0,
238, 84, 84, 84, 68, 68,238,  0,
238,100, 84, 84, 76, 76,228,  0,
 56, 68,130,130,130, 68, 56,  0,
252, 66, 66, 66,124, 64,224,  0,
 56, 68,130,130,146, 76, 58,  0,
252, 66, 66, 66,124, 72,238,  0,
124,130,128,124,  2,130,124,  0,
254,146, 16, 16, 16, 16, 56,  0,
238, 68, 68, 68, 68, 68, 56,  0,
238, 68, 68, 40, 40, 40, 16,  0,
238, 68, 68, 84, 84,108, 68,  0,
238, 68, 40, 16, 40, 68,238,  0,
238, 68, 40, 40, 16, 16, 56,  0,
254,132,  8, 16, 32, 66,254,  0,
 60, 48, 48, 48, 48, 48, 60,  0,
 12, 18, 48,124, 48, 98,252,  0,
 60, 12, 12, 12, 12, 12, 60,  0,
  0,  2,  4,  8, 80, 32, 80,128,
  0, 64, 32, 16, 10,  4, 10,  1,
  0,  0,  0,  0,  0,  0,  0,  0,
 24, 24, 24, 24,  0,  0, 24,  0,
102,102,102,  0,  0,  0,  0,  0,
254,212,170,212,170,212,170,  0,
 24, 62, 96, 60,  6,124, 24,  0,
  0, 32, 80,143, 85, 37,  0,  0,
  8,148, 72, 46, 26, 36,108,  0,
  6, 12, 24,  0,  0,  0,  0,  0,
 12, 24, 48, 48, 48, 24, 12,  0,
 48, 24, 12, 12, 12, 24, 48,  0,
129,102, 44,195, 52,102,129,  0,
  0, 24, 24,126, 24, 24,  0,  0,
  0,  0,  0,  0,  0, 24, 24, 48,
  0,  0,  0,126,  0,  0,  0,  0,
  0,  0,  0,  0,  0, 24, 24,  0,
  0,  3,  6, 12, 24, 48, 96,  0,
 56, 68,130,130,130, 68, 56,  0,
 48, 80,144, 16, 16, 16,254,  0,
124,130,  2,124,128,130,254,  0,
254,132,  8, 28,130,130,124,  0,
 12, 24, 40, 74,254, 10, 28,  0,
254,130,252,  2,130,130,124,  0,
124,130,128,252,130,130,124,  0,
254,132,  8,  8, 16, 16, 56,  0,
124,130,130,124,130,130,124,  0,
124,130,130,130,124,  4,120,  0,
  0,  0, 24,  0,  0, 24,  0,  0,
  0,  0, 24,  0,  0, 24, 24, 48,
  0,126,  0, 60,  0, 24,  0,  0,
239,138, 12,  0,254,170,128,  0,
  0,  0, 24,  0, 60,  0,126,  0,
 60, 66, 66, 28, 16,  0, 16,  0,
  0, 60, 66, 66, 70, 66,126,  0,
  8, 28, 62,127,127, 28, 62,  0,
  0, 60, 66, 66, 70, 66,126,  0,
  0,  0,  0,255,  0,  0,  0,  0,
  0,  0,255,255,  0,  0,  0,  0,
  0,255,255,  0,  0,  0,  0,  0,
  0,  0,  0,  0,255,255,  0,  0,
 48, 48, 48, 48, 48, 48, 48, 48,
 12, 12, 12, 12, 12, 12, 12, 12,
  0,  0,  0,224,240, 56, 24, 24,
 24, 24, 28, 15,  7,  0,  0,  0,
 24, 24, 56,240,224,  0,  0,  0,
192,192,192,192,192,192,255,255,
192,224,112, 56, 28, 14,  7,  3,
  3,  7, 14, 28, 56,112,224,192,
255,255,192,192,192,192,192,192,
255,255,  3,  3,  3,  3,  3,  3,
  8, 24,153,126, 60, 60,102,129,
  0,  0,  0,  0,  0,255,255,  0,
 54,127,107, 99, 42, 28,  8,  0,
 96, 96, 96, 96, 96, 96, 96, 96,
  0,  0,  0,  7, 15, 28, 24, 24,
195,231,126, 60, 60,126,231,195,
  0, 60,126,102,102,126, 60,  0,
 24, 60,114, 98, 36, 24, 60,  0,
  6,  6,  6,  6,  6,  6,  6,  6,
 16, 56,124,226,100, 40, 16,  0,
 24, 24, 24,255,255, 24, 24, 24,
 96,  8, 72, 48,  0, 96,144,144,
 24, 24, 24, 24, 24, 24, 24, 24,
  0, 12,  2,  2, 44,124,236,  0,
255,127, 63, 31, 15,  7,  3,  1,
  0,  0,  0,  0,  0,  0,  0,  0,
240,240,240,240,240,240,240,240,
  0,  0,  0,  0,255,255,255,255,
255,  0,  0,  0,  0,  0,  0,  0,
  0,  0,  0,  0,  0,  0,  0,255,
192,192,192,192,192,192,192,192,
204,135, 48,102,  8,147,199, 70,
  3,  3,  3,  3,  3,  3,  3,  3,
  0,  0,  0,  0,131, 92,100,171,
255,254,252,248,240,224,192,128,
  3,  3,  3,  3,  3,  3,  3,  3,
 24, 24, 24, 31, 31, 24, 24, 24,
  0,  0,  0,  0, 15, 15, 15, 15,
 24, 24, 24, 31, 31,  0,  0,  0,
  0,  0,  0,248,248, 24, 24, 24,
  0,  0,  0,  0,  0,  0,255,255,
  0,  0,  0, 31, 31, 24, 24, 24,
 24, 24, 24,255,255,  0,  0,  0,
  0,  0,  0,255,255, 24, 24, 24,
 24, 24, 24,248,248, 24, 24, 24,
192,192,192,192,192,192,192,192,
224,224,224,224,224,224,224,224,
  7,  7,  7,  7,  7,  7,  7,  7,
255,255,  0,  0,  0,  0,  0,  0,
255,255,255,  0,  0,  0,  0,  0,
  0,  0,  0,  0,  0,255,255,255,
  3,  3,  3,  3,  3,  3,255,255,
  0,  0,  0,  0,240,240,240,240,
 15, 15, 15, 15,  0,  0,  0,  0,
 24, 24, 24,248,248,  0,  0,  0,
240,240,240,240,  0,  0,  0,  0,
240,240,240,240, 15, 15, 15, 15,
195,153,145,145,159,153,195,255,
239,215,215,187,131,187, 17,255,
  3,189,189,131,189,189,  3,255,
199,187,125,127,125,187,199,255,
  3,189,189,189,189,189,  3,255,
129,159,159,135,159,159,129,255,
129,159,159,135,159,159,159,255,
195,153,159,145,153,153,195,255,
153,153,153,129,153,153,153,255,
195,231,231,231,231,231,195,255,
225,243,243,243,243,147,199,255,
153,147,135,143,135,147,153,255,
159,159,159,159,159,159,129,255,
156,136,128,148,156,156,156,255,
153,137,129,129,145,153,153,255,
195,153,153,153,153,153,195,255,
131,153,153,131,159,159,159,255,
195,153,153,153,153,195,241,255,
131,153,153,131,135,147,153,255,
195,153,159,195,249,153,195,255,
129,231,231,231,231,231,231,255,
153,153,153,153,153,153,195,255,
153,153,153,153,153,195,231,255,
156,156,156,148,128,136,156,255,
153,153,195,231,195,153,153,255,
153,153,153,195,231,231,231,255,
129,249,243,231,207,159,129,255,
195,207,207,207,207,207,195,255,
243,237,207,131,207,157,  3,255,
195,243,243,243,243,243,195,255,
255,231,195,129,231,231,231,231,
255,239,207,128,128,207,239,255,
255,255,255,255,255,255,255,255,
231,231,231,231,255,255,231,255,
153,153,153,255,255,255,255,255,
153,153,  0,153,  0,153,153,255,
231,193,159,195,249,131,231,255,
157,153,243,231,207,153,185,255,
195,153,195,199,152,153,192,255,
249,243,231,255,255,255,255,255,
243,231,207,207,207,231,243,255,
207,231,243,243,243,231,207,255,
255,153,195,  0,195,153,255,255,
255,231,231,129,231,231,255,255,
255,255,255,255,255,231,231,207,
255,255,255,129,255,255,255,255,
255,255,255,255,255,231,231,255,
255,252,249,243,231,207,159,255,
195,153,145,137,153,153,195,255,
231,231,199,231,231,231,129,255,
195,153,249,243,207,159,129,255,
195,153,249,227,249,153,195,255,
249,241,225,153,128,249,249,255,
129,159,131,249,249,153,195,255,
195,153,159,131,153,153,195,255,
129,153,243,231,231,231,231,255,
195,153,153,195,153,153,195,255,
195,153,153,193,249,153,195,255,
255,255,231,255,255,231,255,255,
255,255,231,255,255,231,231,207,
241,231,207,159,207,231,241,255,
255,255,129,255,129,255,255,255,
143,231,243,249,243,231,143,255,
195,153,249,243,231,255,231,255,
255,255,255,  0,  0,255,255,255,
247,227,193,128,128,227,193,255,
231,231,231,231,231,231,231,231,
255,255,255,  0,  0,255,255,255,
255,255,  0,  0,255,255,255,255,
255,  0,  0,255,255,255,255,255,
255,255,255,255,  0,  0,255,255,
207,207,207,207,207,207,207,207,
243,243,243,243,243,243,243,243,
255,255,255, 31, 15,199,231,231,
231,231,227,240,248,255,255,255,
231,231,199, 15, 31,255,255,255,
 63, 63, 63, 63, 63, 63,  0,  0,
 63, 31,143,199,227,241,248,252,
252,248,241,227,199,143, 31, 63,
  0,  0, 63, 63, 63, 63, 63, 63,
  0,  0,252,252,252,252,252,252,
255,195,129,129,129,129,195,255,
255,255,255,255,255,  0,  0,255,
201,128,128,128,193,227,247,255,
159,159,159,159,159,159,159,159,
255,255,255,248,240,227,231,231,
 60, 24,129,195,195,129, 24, 60,
255,195,129,153,153,129,195,255,
231,231,153,153,231,231,195,255,
249,249,249,249,249,249,249,249,
247,227,193,128,193,227,247,255,
231,231,231,  0,  0,231,231,231,
 63, 63,207,207, 63, 63,207,207,
231,231,231,231,231,231,231,231,
255,255,252,193,137,201,201,255,
  0,128,192,224,240,248,252,254,
255,255,255,255,255,255,255,255,
 15, 15, 15, 15, 15, 15, 15, 15,
255,255,255,255,  0,  0,  0,  0,
  0,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,  0,
 63, 63, 63, 63, 63, 63, 63, 63,
 51, 51,204,204, 51, 51,204,204,
252,252,252,252,252,252,252,252,
255,255,255,255, 51, 51,204,204,
  0,  1,  3,  7, 15, 31, 63,127,
252,252,252,252,252,252,252,252,
231,231,231,224,224,231,231,231,
255,255,255,255,240,240,240,240,
231,231,231,224,224,255,255,255,
255,255,255,  7,  7,231,231,231,
255,255,255,255,255,255,  0,  0,
255,255,255,224,224,231,231,231,
231,231,231,  0,  0,255,255,255,
255,255,255,  0,  0,231,231,231,
231,231,231,  7,  7,231,231,231,
 63, 63, 63, 63, 63, 63, 63, 63,
 31, 31, 31, 31, 31, 31, 31, 31,
248,248,248,248,248,248,248,248,
  0,  0,255,255,255,255,255,255,
  0,  0,  0,255,255,255,255,255,
255,255,255,255,255,  0,  0,  0,
252,252,252,252,252,252,  0,  0,
255,255,255,255, 15, 15, 15, 15,
240,240,240,240,255,255,255,255,
231,231,231,  7,  7,255,255,255,
 15, 15, 15, 15,255,255,255,255,
 15, 15, 15, 15,240,240,240,240

};

// Function to load and setup the custom character set
static void setup_charset(void) {
    // Load our custom character set into memory at $C000 (49152)
    memcpy(49152, chars, sizeof(chars));

    // Configure the C64's memory layout for custom character set:
    
    // 1. Set up RAM bank for character ROM access
    // CIA2 port A (56576) controls RAM bank selection
    POKE(56576, PEEK(57576) & 252);

    // 2. Configure VIC-II to use our custom character set
    // 53272 is the VIC-II control register for character ROM location
    POKE(53272, 32);

    // 3. Set the cursor character to use our custom character set
    POKE(648, 200);
}
#endif

void center_text(unsigned char row, char *text) {
    sprintf(output, "%s", text);
    cputsxy((40-strlen(text))/2, row, output);
    refresh();
}

// This is the default title screen
int title_screen(void) {
    // if c64 then set the background color to black and the text to green
    #ifdef __C64__
        bgcolor(0);
        bordercolor(0);
        textcolor(5);
        setup_charset();
    #endif

    clrscr();
    
    #ifdef __C64__
        sprintf(output, "c64 dungeon");
    #elif __PET__
        sprintf(output, "pet dungeon");
    #else
        sprintf(output, "The Dungeon");

    #endif



    center_text(15, "a game by retrogamecoders.com");
    center_text(20, "press a key");
    
    
    counter = 0;
    while (!kbhit()) { counter++; }
    in_play = true;
    clrscr();
    return counter;
}

bool game_over(void) {
    clrscr();
    center_text(10, "game over");
    
    timer = dumb_wait(1000);

    center_text(12, "ah, such a shame,");
    center_text(14, "you were doing so well!");
    timer = dumb_wait(1000);
    
    sprintf(output, "score:%03d", score);
    center_text(18, output);
    center_text(19, "play again (y/n)?");
    
    key = cgetc();
    in_play = false;
    if (key == 'n') {
        cursor(1);
        echo();
        refresh();
        return false;
    } else {
        return true;
    }
} 